version: '3.8'

services:
  # FalkorDB - Graph Database
  falkordb:
    image: falkordb/falkordb:latest
    container_name: cv-git-falkordb
    ports:
      - "${FALKORDB_PORT:-6379}:6379"
    volumes:
      - falkordb-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - cv-git-network

  # Qdrant - Vector Database (optional)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: cv-git-qdrant
    ports:
      - "${QDRANT_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - cv-git-network

  # Ollama - Local LLM & Embedding Server (default for embeddings)
  ollama:
    image: ollama/ollama:latest
    container_name: cv-git-ollama
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama-data:/root/.ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
    networks:
      - cv-git-network
    # Uncomment below to enable GPU support (requires nvidia-container-toolkit)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

volumes:
  falkordb-data:
    driver: local
  qdrant-data:
    driver: local
  ollama-data:
    driver: local

networks:
  cv-git-network:
    driver: bridge
